---
layout: post
title:  "[2022 WPCI 프로젝트] Pay Coin Swap Tech"
date:   2022-03-21
excerpt: "페이코인 Swap 프로젝트(PCI to WPCI)"
project: true
tag:
- blockchain
- hyperledger
- Side Chain

comments: true
---


# WPCI 프로젝트

※ Bridge 동작원리
1. Unwrap된 TX이 포함된 이더리움 Block은 48 Block Confirm 후 Finality 보장
1블록 생성 주기 = 15s라고 하면, 48개블록*15초=720초(약 12분) 뒤에 해당 Unwrap TX를 confirm 되었다고 신뢰
2 48 Block Confirm 후 해당 Block에서 Unwrap TX Event를 읽어옴
3 Payprotocol의 브릿지가 job queue에서 tx를 순서대로 처리
가) 성공적인 unwrap TX 처리
(i) (fab) 브릿지 계좌에서 거래소 PCI 계좌(기존 : 사용자)로 '(eth) 실제 wpci 소각 수량' 만큼 이체
(ii) (fab) 사용자 계좌에는 unwrap balance log (type=11) 생성
- unwrap balance log의 RID는 '(eth) 주소 : EOA', ext_tx_id는 '(eth) unwrap tx id'
(iii) (fab) 브릿지 계좌에는 unwrap-complete log (type=13) 생성
- unwrap-complete log의 RID는 '(fab) 주소', ext_tx_id는 '(eth) unwrap tx id'
(iv) (fab) unwrap state 생성 (중복방지)
나) 실패한 unwrap TX 처리 (fab 사용자 계좌가 잘못된 경우)
(i) (fab) 자산 이동 없이 브릿지 계좌에 unwrap-complete log (type=13) 생성
- unwrap-complete log의 RID는 '(fab) 브릿지 주소', ext_tx_id는 '(eth) unwrap tx id', diff는 0
(ii) (fab) unwrap state 생성 (중복방지)




## 거래소 연동 가이드

<img width="715" alt="contentMap" src="https://user-images.githubusercontent.com/45926066/159955456-b0820c09-a0c2-480e-8f26-8aa51a93af9f.png">



■ 거래소 Unwrap 입금 처리 방법
※ 거래소의 PCI계좌로 입금 되는 방식이 기존의 TX의 function name이 transfer인 경우 확인하여 입금 처리
-> TX의 function name이 unwrap인 경우에도 확인하여 입금처리를 하도록 변경해야 합니다.
※ 자산 이동과 관련된 TX의 응답 payload에 balance log가 존재하는데, bridge(wrap, unwrap) 기능이 추가되면서
balance log의 type이 추가 되고 필요한 필드가 추가되었지만, 기존에 있던 필드를 제거하거나 변경한 부분은 없
음을 알려드립니다.
※ 기존 Payprotocol의 Fabric TX에서 입금 처리 관련 로직 확인
1. 기존 입금처리에 대해 TX의 function name이 transfer임을 확인하고 있는 경우
☞ function name = “unwrap” 과 payload의 type = 11을 확인하도록 로직 추가(정상적인 unwrap TX의 경
우에만 unwrap balance log (type=11) 생성되기 때문)
2. 기존 입금처리에 대해 TX의 function name을 보지 않고, payload가 balnace_log 필드를 포함하며,
type=2(send)인 TX만 보고 처리하고 있는 경우
☞ type = 11도 확인하도록 로직 추가(정상적인 unwrap TX의 경우에만 unwrap balance log (type=11) 생
성되기 때문)




